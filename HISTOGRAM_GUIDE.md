# 直方图显示与均衡功能使用指南

## 📊 功能概述

本项目现已完整实现直方图显示和均衡功能，包括：
- ✅ 实时RGB和灰度直方图显示
- ✅ 可调节强度的直方图均衡
- ✅ 两种均衡模式：亮度模式和RGB模式
- ✅ 改进的均衡算法，支持线性强度调节

## 🎯 功能特性

### 1. 直方图显示组件

#### 显示内容
- **RGB通道直方图**：红色、绿色、蓝色三个通道的像素分布
- **灰度直方图**：图像的灰度值分布
- **图例**：清晰的颜色标识

#### 视觉设计
- 半透明填充，可同时查看多个通道
- 网格线辅助，方便读取数值
- 自动归一化，适应不同图像的像素分布
- 响应式尺寸，适配侧边栏宽度

### 2. 直方图均衡功能

#### 均衡强度调节
- **范围**：0% - 100%
- **0%**：完全不均衡（原始图像）
- **100%**：完全均衡（最大对比度增强）
- **中间值**：原始图像与均衡图像的混合

#### 两种均衡模式

**亮度模式（Luminance Mode）**
- 保持色彩比例，只调整亮度
- 适合需要保持原始色彩的场景
- 计算公式：Gray = 0.299*R + 0.587*G + 0.114*B
- 优点：色彩自然，不会产生色偏

**RGB模式（RGB Mode）**
- 对R、G、B三个通道分别进行均衡
- 适合需要增强色彩对比度的场景
- 每个通道独立处理
- 优点：对比度更强，色彩更鲜艳

## 📖 使用方法

### 基础使用流程

1. **导入图像**
   ```
   点击"导入图片"按钮或拖拽图片到画布
   ```

2. **显示直方图**
   ```
   在"直方图均衡"部分，点击"显示直方图"按钮
   直方图会实时显示当前图像的像素分布
   ```

3. **调节均衡强度**
   ```
   拖动"均衡强度"滑块或直接输入数值（0-100）
   实时预览均衡效果
   ```

4. **选择均衡模式**
   ```
   点击"亮度模式"或"RGB模式"按钮切换
   观察不同模式的效果差异
   ```

5. **查看直方图变化**
   ```
   调节参数时，直方图会实时更新
   观察像素分布的变化
   ```

### 高级技巧

#### 技巧1：渐进式调节
```
场景：图像对比度不足，但不想过度处理
操作：
1. 先设置均衡强度为 50%
2. 观察效果
3. 根据需要微调到 40%-60% 之间
```

#### 技巧2：模式对比
```
场景：不确定使用哪种模式
操作：
1. 设置均衡强度为 100%
2. 切换"亮度模式"和"RGB模式"
3. 对比两种模式的效果
4. 选择更合适的模式后，再调节强度
```

#### 技巧3：局部增强
```
场景：只想轻微增强对比度
操作：
1. 使用亮度模式
2. 设置均衡强度为 20%-30%
3. 保持色彩自然的同时增强细节
```

#### 技巧4：色彩增强
```
场景：需要让色彩更鲜艳
操作：
1. 使用RGB模式
2. 设置均衡强度为 60%-80%
3. 配合饱和度调节效果更佳
```

## 🔬 技术原理

### 直方图均衡算法

#### 1. 计算直方图
```typescript
// 统计每个像素值（0-255）的出现次数
histogram[pixelValue]++;
```

#### 2. 计算累积分布函数（CDF）
```typescript
cdf[i] = cdf[i-1] + histogram[i];
```

#### 3. 归一化CDF
```typescript
// 改进的公式，考虑CDF最小值
normalizedCdf[i] = ((cdf[i] - cdfMin) / (totalPixels - cdfMin)) * 255;
```

#### 4. 应用均衡并混合
```typescript
// 根据强度混合原始值和均衡值
newValue = original * (1 - strength) + equalized * strength;
```

### 亮度模式 vs RGB模式

| 特性 | 亮度模式 | RGB模式 |
|------|---------|---------|
| 处理方式 | 基于灰度值调整 | 三通道独立处理 |
| 色彩保持 | ✅ 优秀 | ⚠️ 可能变化 |
| 对比度增强 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 色彩饱和度 | 保持不变 | 可能增强 |
| 适用场景 | 人像、自然风景 | 产品图、艺术照 |
| 处理速度 | 快 | 较快 |

### 算法改进点

#### 1. 线性强度调节
- **问题**：之前0%-100%效果相似
- **解决**：使用线性混合公式
- **效果**：强度变化平滑且明显

#### 2. 改进的CDF归一化
- **问题**：暗部细节丢失
- **解决**：考虑CDF最小非零值
- **效果**：保留暗部和亮部细节

#### 3. RGB通道独立处理
- **问题**：色彩失真
- **解决**：每个通道独立均衡
- **效果**：色彩对比度更强

## 📊 直方图解读

### 形状含义

**左偏（暗图）**
```
直方图主要分布在左侧（0-100）
说明：图像整体偏暗
建议：使用直方图均衡或增加亮度
```

**右偏（亮图）**
```
直方图主要分布在右侧（150-255）
说明：图像整体过亮
建议：使用直方图均衡或减少亮度
```

**中间集中（低对比度）**
```
直方图集中在中间区域（80-180）
说明：对比度不足
建议：使用直方图均衡增强对比度
```

**均匀分布（高对比度）**
```
直方图在整个范围内均匀分布
说明：对比度良好
建议：可能不需要均衡
```

### RGB通道分析

**红色通道高**
- 图像偏红/暖色调
- 可能需要调节RGB通道平衡

**绿色通道高**
- 图像偏绿
- 常见于自然风景照片

**蓝色通道高**
- 图像偏蓝/冷色调
- 常见于天空、水面照片

**三通道平衡**
- 色彩中性，无明显色偏
- 通常是理想状态

## 🎨 应用场景

### 场景1：曝光不足的照片
```
问题：照片拍摄时曝光不足，整体偏暗
解决方案：
1. 显示直方图，确认左偏
2. 使用亮度模式
3. 设置均衡强度 60%-80%
4. 配合亮度调节 +10 到 +20
```

### 场景2：雾霾天气照片
```
问题：照片对比度低，灰蒙蒙
解决方案：
1. 使用亮度模式
2. 设置均衡强度 70%-90%
3. 配合对比度调节 +15 到 +25
```

### 场景3：产品摄影
```
问题：需要突出产品细节和色彩
解决方案：
1. 使用RGB模式
2. 设置均衡强度 50%-70%
3. 配合饱和度调节 +10 到 +15
4. 使用锐化增强细节
```

### 场景4：人像照片
```
问题：需要增强对比度但保持肤色自然
解决方案：
1. 使用亮度模式（重要！）
2. 设置均衡强度 30%-50%
3. 避免使用RGB模式（可能导致肤色失真）
```

## ⚠️ 注意事项

### 1. 过度均衡的问题
- **现象**：图像出现明显的色块、噪点增强
- **原因**：均衡强度过高（>90%）
- **解决**：降低均衡强度到 60%-80%

### 2. 色彩失真
- **现象**：RGB模式下色彩不自然
- **原因**：三通道独立均衡导致色彩比例改变
- **解决**：切换到亮度模式或降低均衡强度

### 3. 噪点放大
- **现象**：均衡后噪点更明显
- **原因**：均衡会放大原有噪点
- **解决**：先使用中值滤波去噪，再进行均衡

### 4. 直方图不更新
- **现象**：调节参数后直方图没有变化
- **原因**：直方图显示被隐藏
- **解决**：点击"显示直方图"按钮

## 🔧 快捷操作

### 键盘快捷键
- `Tab`：在不同滑块间切换
- `↑/↓`：微调均衡强度（±1%）
- `Enter`：确认输入的数值

### 推荐工作流程
1. 导入图像
2. 显示直方图，分析像素分布
3. 根据直方图形状选择处理方式
4. 调节均衡强度和模式
5. 配合其他调整（亮度、对比度、饱和度）
6. 导出最终图像

## 📈 性能优化

### 实时更新机制
- 使用100ms防抖，避免频繁计算
- 直方图计算优化，单次遍历完成
- Canvas绘制使用requestAnimationFrame

### 内存管理
- 直方图数据仅在需要时计算
- 使用TypedArray优化内存占用
- 及时释放临时数据

## 🆕 更新日志

### v0.3.0 (2025-11-05)
- ✅ 添加直方图显示组件
- ✅ 优化直方图均衡算法
- ✅ 添加均衡强度滑块（0-100%）
- ✅ 添加两种均衡模式（亮度/RGB）
- ✅ 改进CDF归一化公式
- ✅ 实现线性强度混合
- ✅ 添加显示/隐藏直方图按钮
- ✅ 实时更新直方图数据

---

**项目地址**: https://github.com/herbal-rin/Fast-image-processing
**当前版本**: v0.3.0
**最后更新**: 2025-11-05

